<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#000000" />
    <link rel="icon" sizes="192x192" href="/favicon.png" />
    <title>Compass</title>
    <style>
      @font-face {
        font-family: Muli;
        src: url("../Muli-Light.ttf");
      }
      * {
        box-sizing: border-box;
      }
      h1,
      h2,
      h3,
      h4 {
        font-family: Muli, serif;
      }
      h1 {
        font-size: 1.2rem;
        padding-left: 1.7rem;
        background: transparent 0% 50% no-repeat;
        background-size: 1.2rem;
      }
      html {
        font-family: Muli, sans-serif;
        font-size: 16px;
        background-color: white;
        color: white;
        background: gray;
        background-size: cover;
        height: 100%;
      }
      [class^="column-"] {
        display: inline-block;
      }
      .column-33 {
        width: 33.33333%;
      }
      .column-25 {
        width: 25%;
      }
      .label {
        font-size: 0.5rem;
      }
      body {
        padding: 0;
        margin: 0;
        height: 100%;
      }
      header {
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        transition: -webkit-transform 0.5s ease-out 0s;
        transition: transform 0.5s ease-out 0s;
      }
      .container {
        padding: 5rem 1rem 8rem 1rem;
        overflow: hidden;
        height: 100%;
        transition: -webkit-transform 0.5s ease-out 0s;
        transition: transform 0.5s ease-out 0s;
      }
      .compass {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
      }
      .compass__rose {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      .compass__rose__dial {
        height: 100%;
        width: 100%;
      }
      .compass__pointer {
        height: 100%;
        width: 100%;
      }
      .btn {
        border: 0;
        color: white;
        cursor: pointer;
        text-align: center;
        height: 4rem;
        background-color: transparent;
        background-position: 50% 50%;
        background-repeat: no-repeat;
        background-size: auto 50%;
        -webkit-tap-highlight-color: transparent;
        outline: none;
      }
      .btn svg * {
        transition: fill 0.5s ease-out 0s;
      }
      .btn--hide {
        display: none;
      }
      .btn--hide.show {
        display: inline-block;
      }
      .btn:active {
        background-color: rgba(127, 127, 127, 0.5);
      }
      .btn__icon {
        height: 50%;
        width: 100%;
      }
      .btn__icon--active {
        display: none;
      }
      .btn__icon--inactive {
        display: block;
      }
      .btn.active .btn__icon--active {
        display: block;
      }
      .btn.active .btn__icon--inactive {
        display: none;
      }
      .status {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
      }
      .position {
        padding-bottom: 0.5rem;
        text-transform: uppercase;
        text-align: center;
      }
      .options {
      }
      .options__btn {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.8);
      }
      .popup.popup--show {
        display: block;
      }
      .popup__content {
        max-width: 300px;
        margin: 0 auto;
        background-color: white;
        color: black;
      }
      .popup__contents {
        padding: 1rem;
      }
      .popup__inner {
      }
      .popup__inner--hide {
        display: none;
      }
      .popup__close {
        display: block;
        padding: 1rem;
        text-align: right;
        width: 100%;
        border: 0;
        background: transparent;
        outline: none;
      }
      .popup__close:hover {
        text-decoration: underline;
        cursor: pointer;
      }
      html.nightmode {
        background: black;
        color: white;
      }
      html.nightmode .container {
        transform: translateY(-2rem);
        -webkit-transform: translateY(-2rem);
      }
      html.nightmode header {
        transform: translateY(-4rem);
        -webkit-transform: translateY(-4rem);
      }
      html.nightmode .label {
        color: rgba(127, 127, 127, 0.8);
      }
      html.nightmode .btn svg * {
        fill: rgba(127, 127, 127, 0.5);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Rotator</h1>
    </header>

    <div class="container">
      <div class="compass">
        <div id="rose" class="compass__rose">
          <svg
            class="compass__rose__dial"
            viewBox="0 0 130 130"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle
              cx="65"
              cy="65"
              r="56"
              stroke="white"
              stroke-width="1"
              fill="none"
            />
            <polyline points="63,9  67,9  65,13" fill="white" />
            <polyline points="121,63  121,67  119,65" fill="white" />
            <polyline points="63,121  67,121  65,119" fill="white" />
            <polyline points="9,63  9,67  11,65" fill="white" />
            <text
              x="65"
              y="4.2"
              font-size="5"
              text-anchor="middle"
              fill="white"
            >
              N
            </text>
            <text
              x="127"
              y="67"
              font-size="5"
              text-anchor="middle"
              fill="white"
            >
              E
            </text>
            <text
              x="65"
              y="129"
              font-size="5"
              text-anchor="middle"
              fill="white"
            >
              S
            </text>
            <text
              x="2.8"
              y="67"
              font-size="5"
              text-anchor="middle"
              fill="white"
            >
              W
            </text>
          </svg>
        </div>
        <div id="targetIndicator" class="compass__rose">
          <svg
            class="compass__pointer"
            viewBox="0 0 130 130"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
          >
            <polyline points="60,60  70,60  65,15" fill="white" />
            <circle
              cx="65"
              cy="65"
              r="7"
              stroke="#b60000"
              stroke-width="7"
              fill="none"
            />
          </svg>
        </div>
        <div id="azimuthIndicator" class="compass__rose">
          <svg
            class="compass__pointer"
            viewBox="0 0 130 130"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
          >
            <polyline points="60,60  70,60  65,15" fill="#b60000" />
            <circle
              cx="65"
              cy="65"
              r="7"
              stroke="#b60000"
              stroke-width="7"
              fill="none"
            />
          </svg>
        </div>
      </div>
    </div>

    <div class="status">
      <div class="position row">
        <div class="column-33">
          <div class="label">Azimuth</div>
          <div id="currentAzimuth">N/A</div>
        </div>
        <div class="column-33">
          <div class="label">Target</div>
          <div id="targetAzimuth">N/A</div>
        </div>
        <div class="column-33">
          <div class="label">Speed</div>
          <div id="rotationSpeed">N/A</div>
        </div>
      </div>

      <div class="options row">
        <button
          id="btn-lock-orientation"
          class="btn options__btn column-33"
          type="button"
        >
          <svg
            alt="lock off"
            class="btn__icon btn__icon--inactive"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            width="512px"
            height="512px"
            viewBox="0 0 512 512"
            enable-background="new 0 0 512 512"
            xml:space="preserve"
          >
            <path
              id="lock-15-icon"
              d="M256,90.001c91.74,0,166,74.243,166,166c0,91.74-74.243,165.998-166,165.998
                        c-91.741,0-166-74.241-166-165.998C90,164.259,164.243,90.001,256,90.001 M256,50.001c-113.771,0-206,92.229-206,206
                        s92.229,205.998,206,205.998c113.771,0,206-92.227,206-205.998S369.771,50.001,256,50.001L256,50.001z M358.999,242.667V347h-148
                        V242.667H358.999z M238.667,196.333v31.334h25v-31.334c0-30.511-24.822-55.333-55.334-55.333c-30.51,0-55.332,24.822-55.332,55.333
                        v31.334h25v-31.334c0-16.726,13.607-30.333,30.332-30.333C225.06,166,238.667,179.607,238.667,196.333z"
              fill="white"
            />
          </svg>
          <svg
            alt="lock on"
            class="btn__icon btn__icon--active"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            width="512px"
            height="512px"
            viewBox="0 0 512 512"
            enable-background="new 0 0 512 512"
            xml:space="preserve"
          >
            <path
              id="lock-13-icon"
              d="M256,90.001c91.74,0,166,74.243,166,166c0,91.74-74.243,165.998-166,165.998
                        c-91.741,0-166-74.241-166-165.998C90,164.259,164.243,90.001,256,90.001 M256,50.001c-113.771,0-206,92.229-206,206
                        s92.229,205.998,206,205.998c113.771,0,206-92.227,206-205.998S369.771,50.001,256,50.001L256,50.001z M201.225,227.537v-31.585
                        c0-30.755,25.021-55.776,55.775-55.776s55.775,25.021,55.775,55.776v31.585h-25.2v-31.585c0-16.859-13.716-30.576-30.575-30.576
                        s-30.575,13.717-30.575,30.576v31.585H201.225z M182.409,242.656v105.169h149.182V242.656H182.409z"
              fill="white"
            />
          </svg>
        </button>

        <button
          id="btn-nightmode"
          class="btn options__btn column-33"
          type="button"
        >
          <svg
            lock="nightmode off"
            class="btn__icon btn__icon--inactive"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            width="512px"
            height="512px"
            viewBox="0 0 512 512"
            enable-background="new 0 0 512 512"
            xml:space="preserve"
          >
            <path
              d="M255.5,156c-55.141,0-100,44.86-100,100c0,55.141,44.859,100,100,100s100-44.859,100-100
                        C355.5,200.86,310.641,156,255.5,156z M255.5,316c-33.084,0-60-26.916-60-60s26.916-60,60-60s60,26.916,60,60S288.584,316,255.5,316
                        z M150.779,179.064l-54.586-54.586l28.285-28.284l54.664,54.664C168.305,158.75,158.73,168.272,150.779,179.064z M332.436,151.28
                        l55.086-55.086l28.285,28.284l-55.164,55.165C352.75,168.805,343.229,159.229,332.436,151.28z M127.039,276H50v-40h77.039
                        c-1.012,6.521-1.539,13.2-1.539,20C125.5,262.801,126.027,269.479,127.039,276z M236,127.463V50h40v77.622
                        c-6.68-1.062-13.525-1.622-20.5-1.622C248.873,126,242.362,126.502,236,127.463z M179.143,361.143l-54.664,54.664l-28.285-28.285
                        l54.586-54.585C158.729,343.729,168.305,353.251,179.143,361.143z M462,236v40h-78.039c1.012-6.521,1.539-13.199,1.539-20
                        c0-6.8-0.527-13.479-1.539-20H462z M276,384.378V462h-40v-77.463c6.362,0.962,12.873,1.463,19.5,1.463
                        C262.475,386,269.32,385.441,276,384.378z M360.643,332.357l55.164,55.164l-28.285,28.285l-55.086-55.086
                        C343.229,352.771,352.751,343.195,360.643,332.357z"
              fill="white"
            />
          </svg>
          <svg
            class="btn__icon btn__icon--active"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            width="512px"
            height="512px"
            viewBox="0 0 512 512"
            enable-background="new 0 0 512 512"
            xml:space="preserve"
          >
            <circle cx="256" cy="256" r="206" fill="white" />
          </svg>
        </button>

        <button
          id="btn-info"
          class="btn btn-popup options__btn column-33"
          type="button"
          data-name="info"
        >
          <svg
            alt="info"
            class="btn__icon btn__icon--inactive"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            width="512px"
            height="512px"
            viewBox="0 0 512 512"
            enable-background="new 0 0 512 512"
            xml:space="preserve"
          >
            <path
              id="info-2-icon"
              d="M255.998,90.001c91.74,0,166.002,74.241,166.002,165.998c0,91.741-74.245,166-166.002,166
                c-91.74,0-165.998-74.243-165.998-166C90,164.259,164.243,90.001,255.998,90.001 M255.998,50.001
                C142.229,50.001,50,142.229,50,255.999c0,113.771,92.229,206,205.998,206c113.771,0,206.002-92.229,206.002-206
                C462,142.229,369.77,50.001,255.998,50.001L255.998,50.001z M285.822,367.567h-57.646V230.6h57.646V367.567z M257,202.268
                c-17.522,0-31.729-14.206-31.729-31.73c0-17.522,14.206-31.729,31.729-31.729c17.524,0,31.728,14.206,31.728,31.729
                C288.728,188.062,274.524,202.268,257,202.268z"
              fill="white"
            />
          </svg>
        </button>
      </div>
    </div>

    <div id="popup" class="popup">
      <div id="popup-content" class="popup__content">
        <div id="popup-contents" class="popup__contents">
          <div id="popup-inner-info" class="popup__inner popup__inner--hide">
            <p>
              This is antenna rotator for
              <a href="https://om3kff.sk">OM3kFF</a>.
            </p>
            <p>
              For information about uptime go <a href="/uptime">here</a>. For
              information about ram visit <a href="/heap">this</a>.
            </p>
            <p>
              This project's GUI is based on<a
                href="https://github.com/lamplightdev/compass"
                >Chris Haynes</a
              >
              work.
            </p>
          </div>
          <div
            id="popup-inner-lostconnction"
            class="popup__inner popup__inner--hide"
          >
            <p>Connection to rotator has been lost. Trying to reconnect.</p>
          </div>
        </div>
        <button id="popup-close" class="popup__close" href="#">close</button>
      </div>
    </div>

    <script>
      (function () {
        "use strict";

        // the outer part of the compass that rotates
        var rose = document.getElementById("rose");
        var azimuthIndicator = document.getElementById("azimuthIndicator");
        var targetIndicator = document.getElementById("targetIndicator");

        var compassContainer = document.querySelector(".compass");

        // elements that ouput our position
        var currentAzimuth = document.getElementById("currentAzimuth");
        var targetAzimuth = document.getElementById("targetAzimuth");
        var rotationSpeed = document.getElementById("rotationSpeed");

        // info popup elements, push buttons that open popups
        var popup = document.getElementById("popup");
        var popupContents = document.getElementById("popup-contents");
        var popupInners = document.querySelectorAll(".popup__inner");
        var btnsPopup = document.querySelectorAll(".btn-popup");

        // buttons at the bottom of the screen
        var btnLockOrientation = document.getElementById(
          "btn-lock-orientation"
        );
        var btnNightmode = document.getElementById("btn-nightmode");
        var btnInfo = document.getElementById("btn-info");

        // if we have shown the heading unavailable warning yet
        var warningHeadingShown = false;

        // switches keeping track of our current app state
        var isOrientationLockable = false;
        var isOrientationLocked = false;
        var isNightMode = false;

        // the orientation of the device on app load
        var defaultOrientation;

        // browser agnostic orientation
        function getBrowserOrientation() {
          var orientation;
          if (screen.orientation && screen.orientation.type) {
            orientation = screen.orientation.type;
          } else {
            orientation =
              screen.orientation ||
              screen.mozOrientation ||
              screen.msOrientation;
          }

          /*
            'portait-primary':      for (screen width < screen height, e.g. phone, phablet, small tablet)
                                        device is in 'normal' orientation
                                    for (screen width > screen height, e.g. large tablet, laptop)
                                        device has been turned 90deg clockwise from normal
        
            'portait-secondary':    for (screen width < screen height)
                                        device has been turned 180deg from normal
                                    for (screen width > screen height)
                                        device has been turned 90deg anti-clockwise (or 270deg clockwise) from normal
        
            'landscape-primary':    for (screen width < screen height)
                                        device has been turned 90deg clockwise from normal
                                    for (screen width > screen height)
                                        device is in 'normal' orientation
        
            'landscape-secondary':  for (screen width < screen height)
                                        device has been turned 90deg anti-clockwise (or 270deg clockwise) from normal
                                    for (screen width > screen height)
                                        device has been turned 180deg from normal
            */

          return orientation;
        }

        // browser agnostic orientation unlock
        function browserUnlockOrientation() {
          if (screen.orientation && screen.orientation.unlock) {
            screen.orientation.unlock();
          } else if (screen.unlockOrientation) {
            screen.unlockOrientation();
          } else if (screen.mozUnlockOrientation) {
            screen.mozUnlockOrientation();
          } else if (screen.msUnlockOrientation) {
            screen.msUnlockOrientation();
          }
        }

        // browser agnostic document.fullscreenElement
        function getBrowserFullscreenElement() {
          if (typeof document.fullscreenElement !== "undefined") {
            return document.fullscreenElement;
          } else if (typeof document.webkitFullscreenElement !== "undefined") {
            return document.webkitFullscreenElement;
          } else if (typeof document.mozFullScreenElement !== "undefined") {
            return document.mozFullScreenElement;
          } else if (typeof document.msFullscreenElement !== "undefined") {
            return document.msFullscreenElement;
          }
        }

        // browser agnostic document.documentElement.requestFullscreen
        function browserRequestFullscreen() {
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.mozRequestFullScreen) {
            document.documentElement.mozRequestFullScreen();
          } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
          }
        }

        // browser agnostic document.documentElement.exitFullscreen
        function browserExitFullscreen() {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }

        function showHeadingWarning() {
          if (!warningHeadingShown) {
            popupOpen("noorientation");
            warningHeadingShown = true;
          }
        }

        function onFullscreenChange() {
          if (isOrientationLockable && getBrowserFullscreenElement()) {
            if (screen.orientation && screen.orientation.lock) {
              screen.orientation
                .lock(getBrowserOrientation())
                .then(function () {})
                .catch(function () {});
            }
          } else {
            lockOrientationRequest(false);
          }
        }

        function toggleOrientationLockable(lockable) {
          isOrientationLockable = lockable;

          if (isOrientationLockable) {
            btnLockOrientation.classList.remove("btn--hide");

            btnNightmode.classList.add("column-25");
            btnNightmode.classList.remove("column-33");
            btnInfo.classList.add("column-25");
            btnInfo.classList.remove("column-33");
          } else {
            btnLockOrientation.classList.add("btn--hide");

            btnNightmode.classList.add("column-33");
            btnNightmode.classList.remove("column-25");
            btnInfo.classList.add("column-33");
            btnInfo.classList.remove("column-25");
          }
        }

        function checkLockable() {
          if (screen.orientation && screen.orientation.lock) {
            screen.orientation
              .lock(getBrowserOrientation())
              .then(function () {
                toggleOrientationLockable(true);
                browserUnlockOrientation();
              })
              .catch(function (event) {
                if (event.code === 18) {
                  // The page needs to be fullscreen in order to call lockOrientation(), but is lockable
                  toggleOrientationLockable(true);
                  browserUnlockOrientation(); //needed as chrome was locking orientation (even if not in fullscreen, bug??)
                } else {
                  // lockOrientation() is not available on this device (or other error)
                  toggleOrientationLockable(false);
                }
              });
          } else {
            toggleOrientationLockable(false);
          }
        }

        function lockOrientationRequest(doLock) {
          if (isOrientationLockable) {
            if (doLock) {
              browserRequestFullscreen();
              lockOrientation(true);
            } else {
              browserUnlockOrientation();
              browserExitFullscreen();
              lockOrientation(false);
            }
          }
        }

        function lockOrientation(locked) {
          if (locked) {
            btnLockOrientation.classList.add("active");
          } else {
            btnLockOrientation.classList.remove("active");
          }

          isOrientationLocked = locked;
        }

        function toggleOrientationLock() {
          if (isOrientationLockable) {
            lockOrientationRequest(!isOrientationLocked);
          }
        }

        function setNightmode(on) {
          if (on) {
            btnNightmode.classList.add("active");
          } else {
            btnNightmode.classList.remove("active");
          }

          window.setTimeout(function () {
            if (on) {
              document.documentElement.classList.add("nightmode");
            } else {
              document.documentElement.classList.remove("nightmode");
            }
          }, 1);

          isNightMode = on;
        }

        function toggleNightmode() {
          setNightmode(!isNightMode);
        }

        function popupOpenFromClick(event) {
          popupOpen(event.currentTarget.dataset.name);
        }

        function popupOpen(name) {
          var i;
          for (i = 0; i < popupInners.length; i++) {
            popupInners[i].classList.add("popup__inner--hide");
          }
          document
            .getElementById("popup-inner-" + name)
            .classList.remove("popup__inner--hide");

          popup.classList.add("popup--show");
        }

        function popupClose() {
          popup.classList.remove("popup--show");
        }

        function popupContentsClick(event) {
          event.stopPropagation();
        }

        function decimalToSexagesimal(decimal, type) {
          var degrees = decimal | 0;
          var fraction = Math.abs(decimal - degrees);
          var minutes = (fraction * 60) | 0;
          var seconds = (fraction * 3600 - minutes * 60) | 0;

          var direction = "";
          var positive = degrees > 0;
          degrees = Math.abs(degrees);
          switch (type) {
            case "lat":
              direction = positive ? "N" : "S";
              break;
            case "lng":
              direction = positive ? "E" : "W";
              break;
          }

          return degrees + "째 " + minutes + "' " + seconds + '" ' + direction;
        }

        if (screen.width > screen.height) {
          defaultOrientation = "landscape";
        } else {
          defaultOrientation = "portrait";
        }

        document.addEventListener("fullscreenchange", onFullscreenChange);
        document.addEventListener("webkitfullscreenchange", onFullscreenChange);
        document.addEventListener("mozfullscreenchange", onFullscreenChange);
        document.addEventListener("MSFullscreenChange", onFullscreenChange);

        btnLockOrientation.addEventListener("click", toggleOrientationLock);
        btnNightmode.addEventListener("click", toggleNightmode);

        var i;
        for (i = 0; i < btnsPopup.length; i++) {
          btnsPopup[i].addEventListener("click", popupOpenFromClick);
        }

        popup.addEventListener("click", popupClose);
        popupContents.addEventListener("click", popupContentsClick);

        setNightmode(true);
        checkLockable();

        const gateway = `ws://${window.location.hostname}/ws`;
        //const gateway = `ws://192.168.1.249/ws`;

        let socket = new WebSocket(gateway);
        let messageTimeout;

        function resetMessageTimeout() {
          clearTimeout(messageTimeout);
          messageTimeout = setTimeout(() => {
            console.log("Connection timeout, closing and reconnecting...");
            popupOpen("lostconnction");

            socket.close();
            setupWebSocket();
          }, 5000);
        }

        function setupWebSocket() {
          resetMessageTimeout();
          socket = new WebSocket(gateway);

          socket.onopen = () => {
            console.log("WebSocket connection opened.");
            popupClose();
            resetMessageTimeout();
          };

          socket.onmessage = (event) => {
            //console.log("Got new data: " + event.data);
            const data = JSON.parse(event.data);
            if (
              data.current_position !== undefined &&
              data.target_position !== undefined
            ) {
              const { current_position, target_position, current_speed } = data;

              currentAzimuth.textContent = current_position + "째";
              targetAzimuth.textContent = target_position + "째";
              rotationSpeed.textContent = current_speed + "째";

              rotateIndicator(azimuthIndicator, current_position);
              if (!mousepressed)
                rotateIndicator(targetIndicator, target_position);
            }
            resetMessageTimeout();
          };
        }
        setupWebSocket();

        function rotateIndicator(indicator, angle) {
          const indicatorAngle = `rotate(${angle}deg)`;

          if (typeof indicator.style.transform !== "undefined") {
            indicator.style.transform = "rotateZ(" + angle + "deg)";
          } else if (
            typeof azimuthIndicator.style.webkitTransform !== "undefined"
          ) {
            indicator.style.webkitTransform = "rotateZ(" + angle + "deg)";
          }
        }

        function calculateAzimuth(event) {
          var boundingBox = compassContainer.getBoundingClientRect();
          var centerX = boundingBox.left + boundingBox.width / 2;
          var centerY = boundingBox.top + boundingBox.height / 2;

          var angle = Math.atan2(
            event.clientY - centerY,
            event.clientX - centerX
          );
          var azimuth = (angle * (180 / Math.PI) + 360 + 90) % 360;
          return azimuth;
        }

        function handleMove(event) {
          if (
            (event.buttons === 1 && event.type === "mousemove") ||
            event.type === "click" ||
            event.type === "touchstart" ||
            event.type === "touchmove"
          ) {
            var azimuth = calculateAzimuth(event);
            if (event.type != "mousemove") {
              const message = {
                target_position: parseInt(azimuth, 10),
              };
              socket.send(JSON.stringify(message));
            } else rotateIndicator(targetIndicator, azimuth);
          }
        }

        compassContainer.addEventListener("click", handleMove);
        compassContainer.addEventListener("mousemove", handleMove);

        var mousepressed;
        document.addEventListener("mousedown", function (event) {
          if (event.button === 0) {
            mousepressed = true;
          }
        });

        document.addEventListener("mouseup", function (event) {
          if (event.button === 0) {
            mousepressed = false;
          }
        });

        const darkModeToggle = document.getElementById("darkModeToggle");
      })();
    </script>
  </body>
</html>
